= Web Service using Spring Boot and AWS
:toc:

{sp}+

* 학습시 의문점은 https://github.com/jojoldu/freelec-springboot2-webservice 에서 검색하거나 질문을 올릴 수 있다.

{sp}+

=== Chap 02. 테스트 코드 작성
* 컨트롤러와 관련된 클래스는 모두 ``web`` package에 추가한다.
* 모든 응답 DTO는 ``web\dto`` package에 추가한다.

NOTE: Data Transfer Object의 약자로, 계층간 데이터 교환을 위한 자바빈즈를 뜻한다. +
또한 DTO는 VO(Value Object)와 용어를 혼용해서 많이 사용하는데, VO는 읽기만 가능한 read only 속성을 가져 DTO와의 차이점이 존재한다. +
일반적으로 DTO는 로직을 가지고 있지 않은 순수한 데이터의 객체이며 객체의 속성과 그 속성의 접근을 위한 getter 및 setter 메소드만을 가지고 있다.

{sp}+

=== Chap 03. JPA 사용하기
* JPA는 인터페이스로서 자바 표준명세서. 아래와 같은 관계를 숙지하자.
====
JPA ← Hibernate ← Spring Data JPA
====

* Hibernate를 쓰는 것과 Spring Data JPA를 쓰는 것 사이에는 차이가 없다. 즉 한 단계 더 감싸놓은 것. +
나중에 Hibernate 외에 다른 구현체로 쉽게 교체하기 위해서이다. (관계형 데이터베이스를 MongoDB로 바꾸는 식의 변경도 손쉽게 된다)

---

* 도메인을 담을 package로 ``domain`` 추가. +
여기서 도메인이란 게시글, 댓글, 회원, 정산, 결제 등 소프트웨어에 대한 요구사항 또는 문제영역이라고 생각하면 된다.
** 기존에 MyBatis 같은 쿼리 매퍼를 사용했다면 dao package를 떠올리겠지만 조금 다르다. 즉 그간 xml에 쿼리를 담고, 클래스는 오로지 쿼리 결과만 담던 일들이 모두 도메인 클래스라 불리는 곳에서 해결된다.

* Entity의 PK 관련하여 -

image::./img/3-01.jpg[]

* Repository는 MyBatis 등에서 DAO라고 불리는 DB Layer 접근자

image::./img/3-02.jpg[]

---

* API를 만들기 위해 총 3개의 클래스가 필요하다.
** Request 데이터를 받을 DTO
** API 요청을 받을 Controller
** 트랜잭션, 도메인 기능 간의 순서를 보장하는 Service

* https://www.petrikainulainen.net/software-development/design/understanding-spring-web-application-architecture-the-classic-way/[Understanding Spring Web Application Architecture: The Classic Way] 참조. 아래 화면 캡처에 그 일부 내용이 있다.

image::./img/3-03.jpg[]

image::./img/3-04.jpg[]

* H2 Database 접속 URL은 http://localhost:8080/h2-console

image::./img/3-05.jpg[]

image::./img/3-06.jpg[]

image::./img/3-07.jpg[]

{sp}+

=== Chap 04. Mustache로 화면 구성하기
Bootstrap 최신버젼인 v4.6.0 기준으로 Bootstrap 웹사이트 문서에 따라 ``header.mustache``, ``footer.mustache``를 작성시 오류 발생.

확인 결과 ``footer.mustache``에 삽입한 jQuery가 제대로 동작하지 않은 것이 원인이었다. +
즉 'slim' 버젼이 아니라 'full' 버젼을 사용해야하고 ``integrity`` 속성도 빼야 했다.

---
https://stackoverflow.com/questions/32087469/the-attribute-readonly-is-undefined-for-the-annotation-type-transactional[The attribute readOnly is undefined for the annotation type Transactional]

* ``org.springframework.transaction.annotation.Transactional``을 지정해야한다.

---

image::./img/4-01.jpg[]

image::./img/4-02.jpg[]

image::./img/4-03.jpg[]

image::./img/4-04.jpg[]

image::./img/4-05.jpg[]

{sp}+

=== Chap 05. Spring Security와 OAuth 2.0으로 로그인 기능 구현
구글 서비스 사용은 정말 안습이다. +
일단 수행한 작업은 아래와 같다.

. 프로젝트 생성
. OAuth 동의 화면(OAuth consent screen) 만들기
 .. 4단계 화면으로 되어 있다. (왜 이렇게 만들었을까 -_-a) +
'Scope' 선택은 2번째 단계에 있다.
 .. 작업 후 'Publishing' 해야 애플리케이션이 제대로 동작한다.
. OAuth client ID 만들기
 - Credentials > Create Credentials 에서 'OAuth client ID' 선택

---

* ``config.auth`` 패키지를 생성하고 Security 관련 클래스는 모두 여기에 담는다.

* Service에게 명령을 내리는 주체가 Controller가 아닌 Security가 되게 되는데, Security 역시 Controller와 같은 Web 계층이라서 문제가 되지 않는다. +
세부적인 내용은 https://github.com/jojoldu/freelec-springboot2-webservice/issues/32[여기]를 참조하자.

---

image::./img/5-00-1.jpg[]
image::./img/5-00-2.jpg[]
image::./img/5-00-3.jpg[]
image::./img/5-01.jpg[SecurityConfig.java]
image::./img/5-02.jpg[CustomOAuth2UserService.java]
image::./img/5-03.jpg[OAuthAttributes.java]
image::./img/5-04.jpg[SessionUser.java]
image::./img/5-05.jpg[index.mustache 외]
image::./img/5-06.jpg[Annotation 적용 #1]
image::./img/5-07.jpg[Annotation 적용 #2]
image::./img/5-08.jpg[세션 저장소로 데이터베이스 사용하기]
image::./img/5-09.jpg[기존 테스트에 시큐리티 적용]
image::./img/5-10.jpg[]
image::./img/5-11.jpg[]
image::./img/5-12.jpg[]
image::./img/5-13.jpg[]
image::./img/5-14.jpg[]

{sp}+
